"use strict";(self.webpackChunkodps_sdk_doc=self.webpackChunkodps_sdk_doc||[]).push([[206],{7224:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>l});var i=t(5893),o=t(1151);const a={title:"\u4f7f\u7528 Tunnel \u8fdb\u884c\u6d41\u5f0f\u4e0a\u4f20",sidebar_label:"\u4f7f\u7528 Tunnel \u8fdb\u884c\u6d41\u5f0f\u4e0a\u4f20",sidebar_position:4},s="\u963f\u91cc\u4e91 MaxCompute (ODPS) \u6570\u636e\u6d41\u4e0a\u4f20\u793a\u4f8b",r={id:"example-code/streaming-upload",title:"\u4f7f\u7528 Tunnel \u8fdb\u884c\u6d41\u5f0f\u4e0a\u4f20",description:"\u672c\u6587\u6863\u5c55\u793a\u4e86\u5982\u4f55\u4f7f\u7528\u963f\u91cc\u4e91MaxCompute\u7684\u6d41\u5f0f\u4e0a\u4f20\u529f\u80fd\u5c06\u6570\u636e\u4e0a\u4f20\u5230ODPS\u8868\u4e2d\u3002\u793a\u4f8b\u4f7f\u7528Access Key\u8fdb\u884c\u8ba4\u8bc1\u3002",source:"@site/docs/example-code/streaming-upload.md",sourceDirName:"example-code",slug:"/example-code/streaming-upload",permalink:"/aliyun-odps-java-sdk/example-code/streaming-upload",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"\u4f7f\u7528 Tunnel \u8fdb\u884c\u6d41\u5f0f\u4e0a\u4f20",sidebar_label:"\u4f7f\u7528 Tunnel \u8fdb\u884c\u6d41\u5f0f\u4e0a\u4f20",sidebar_position:4},sidebar:"docs",previous:{title:"\u6267\u884c\u5efa\u8868\u64cd\u4f5c",permalink:"/aliyun-odps-java-sdk/example-code/create-table"},next:{title:"\u4f7f\u7528 Tunnel \u8fdb\u884c Delta Table \u7684 Upsert \u64cd\u4f5c",permalink:"/aliyun-odps-java-sdk/example-code/upsert"}},c={},l=[{value:"\u76ee\u5f55",id:"\u76ee\u5f55",level:2},{value:"\u7b80\u4ecb",id:"\u7b80\u4ecb",level:2},{value:"\u793a\u4f8b\u4ee3\u7801",id:"\u793a\u4f8b\u4ee3\u7801",level:3},{value:"\u521d\u59cb\u5316ODPS\u5ba2\u6237\u7aef",id:"\u521d\u59cb\u5316odps\u5ba2\u6237\u7aef",level:2},{value:"\u672c\u6587\u6863\u5f85\u5b8c\u5584",id:"\u672c\u6587\u6863\u5f85\u5b8c\u5584",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\u963f\u91cc\u4e91-maxcompute-odps-\u6570\u636e\u6d41\u4e0a\u4f20\u793a\u4f8b",children:"\u963f\u91cc\u4e91 MaxCompute (ODPS) \u6570\u636e\u6d41\u4e0a\u4f20\u793a\u4f8b"})}),"\n",(0,i.jsx)(n.p,{children:"\u672c\u6587\u6863\u5c55\u793a\u4e86\u5982\u4f55\u4f7f\u7528\u963f\u91cc\u4e91MaxCompute\u7684\u6d41\u5f0f\u4e0a\u4f20\u529f\u80fd\u5c06\u6570\u636e\u4e0a\u4f20\u5230ODPS\u8868\u4e2d\u3002\u793a\u4f8b\u4f7f\u7528Access Key\u8fdb\u884c\u8ba4\u8bc1\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"\u76ee\u5f55",children:"\u76ee\u5f55"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#%E7%AE%80%E4%BB%8B",children:"\u7b80\u4ecb"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#%E5%88%9D%E5%A7%8B%E5%8C%96ODPS%E5%AE%A2%E6%88%B7%E7%AB%AF",children:"\u521d\u59cb\u5316ODPS\u5ba2\u6237\u7aef"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u7b80\u4ecb",children:"\u7b80\u4ecb"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"TunnelStreamingUploadExample"}),"\u7c7b\u5c55\u793a\u4e86\u5982\u4f55\u4f7f\u7528\u6d41\u5f0f\u4e0a\u4f20\u529f\u80fd\u5c06\u6570\u636e\u4e0a\u4f20\u5230ODPS\u3002\u8bf7\u786e\u4fdd\u5c06\u5360\u4f4d\u7b26\u66ff\u6362\u4e3a\u60a8\u5b9e\u9645\u7684ODPS\u51ed\u8bc1\u548c\u53c2\u6570\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"\u793a\u4f8b\u4ee3\u7801",children:"\u793a\u4f8b\u4ee3\u7801"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'import java.io.IOException;\nimport java.util.concurrent.TimeUnit;\nimport com.aliyun.odps.account.Account;\nimport com.aliyun.odps.account.AliyunAccount;\nimport com.aliyun.odps.account.StsAccount;\nimport com.aliyun.odps.data.Record;\nimport com.aliyun.odps.task.SQLTask;\nimport com.aliyun.odps.tunnel.TableTunnel;\nimport com.aliyun.odps.tunnel.TunnelException;\n\npublic class TunnelStreamingUploadExample {\n  private static String accessId = "<your access id>";\n  private static String accessKey = "<your access Key>";\n  private static String odpsUrl = "<your odps endpoint>";\n  private static String project = "<your project>";\n  private static String table = "<your table name>";\n  private static String partition;\n\n  private static Odps getOdps() {\n    Account account = new AliyunAccount(accessId, accessKey);\n    Odps odps = new Odps(account);\n    odps.setEndpoint(odpsUrl);\n    odps.setDefaultProject(project);\n    return odps;\n  }\n\n  public static void main(String[] args) throws Exception {\n    Odps odps = getOdps();\n    createTestTable();\n    try {\n      TableTunnel.StreamUploadSession session =\n          odps.tableTunnel()\n              .buildStreamUploadSession(odps.getDefaultProject(), table)\n              .setPartitionSpec(partition == null ? null : new PartitionSpec(partition))\n              .build();\n      TableTunnel.StreamRecordPack recordPack = session.newRecordPack();\n      for (int i = 0; i < 3; i++) {\n        Record record = session.newRecord();\n        record.setBigint("c1", (long) i);\n        record.setBigint("c2", (long) (i * 2));\n        recordPack.append(record);\n      }\n      recordPack.flush();\n      showTable();\n      triggerSchemaEvolution();\n      for (int retry = 0; retry < 10; retry++) {\n        session =\n            odps.tableTunnel()\n                .buildStreamUploadSession(odps.getDefaultProject(), table)\n                .setPartitionSpec(partition == null ? null : new PartitionSpec(partition))\n                .build();\n        if (session.getSchema().getAllColumns().size() == 3) {\n          break;\n        }\n        TimeUnit.SECONDS.sleep(6);\n      }\n      recordPack = session.newRecordPack();\n      for (int i = 0; i < 3; i++) {\n        Record record = session.newRecord();\n        record.setBigint("c1", (long) i);\n        record.setBigint("c2", (long) (i * 2));\n        record.setBigint("c3", (long) (i * 3));\n        recordPack.append(record);\n      }\n      recordPack.flush();\n      showTable();\n    } catch (TunnelException e) {\n      System.err.println("Tunnel Exception: " + e.getMessage());\n      e.printStackTrace();\n    } catch (IOException e) {\n      System.err.println("IO Exception: " + e.getMessage());\n      e.printStackTrace();\n    }\n  }\n\n  private static void createTestTable() throws OdpsException {\n    getOdps()\n        .tables()\n        .newTableCreator(table, TableSchema.builder()\n            .withBigintColumn("c1")\n            .withBigintColumn("c2")\n            .build())\n        .ifNotExists()\n        .create();\n  }\n\n  private static void triggerSchemaEvolution() throws OdpsException {\n    Instance instance = SQLTask.run(getOdps(), "alter table " + table + " add column c3 bigint;");\n    instance.waitForSuccess();\n  }\n\n  private static void showTable() throws OdpsException {\n    getOdps().tables().get(table).read(10).forEach(System.out::println);\n    System.out.println("\\n");\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u521d\u59cb\u5316odps\u5ba2\u6237\u7aef",children:"\u521d\u59cb\u5316ODPS\u5ba2\u6237\u7aef"}),"\n",(0,i.jsx)(n.p,{children:"\u6b64\u65b9\u6cd5\u4f7f\u7528Access Key\u8fdb\u884c\u8ba4\u8bc1\uff0c\u521d\u59cb\u5316ODPS\u5ba2\u6237\u7aef\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"\u672c\u6587\u6863\u5f85\u5b8c\u5584",children:"\u672c\u6587\u6863\u5f85\u5b8c\u5584"})]})}function p(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>s});var i=t(7294);const o={},a=i.createContext(o);function s(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);